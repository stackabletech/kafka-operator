---
apiVersion: kuttl.dev/v1beta1
kind: TestStep
timeout: 300
---
apiVersion: batch/v1
kind: Job
metadata:
  name: read-data
spec:
  template:
    spec:
      containers:
        - name: read-data
          image: edenhill/kcat:1.7.1
          command: [sh, -euo, pipefail, -c]
          args:
            - |
              echo "message written after upgrade" > message
              kcat -b $KAFKA -t upgrade-test-data -P message

              echo "message written before upgrade" > expected-messages
              echo >> expected-messages
              cat message >> expected-messages
              echo >> expected-messages
              kcat -b $KAFKA -t upgrade-test-data -C -e > read-messages
              diff read-messages expected-messages
              cmp read-messages expected-messages
          env:
            - name: KAFKA
              valueFrom:
                configMapKeyRef:
                  name: simple-kafka
                  key: KAFKA
      restartPolicy: Never
